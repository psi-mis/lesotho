
--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_ARTRefer_AllFollowUp



select 

-- Latest [Positive] event of TEI
max( hivtestingevent.executiondate ) as positiveevent_date

, ( select '{"eventId":"' || _psi.uid || '","daySinceDiagnosis":"' || extract(day from (date 'now()' - _psi.executiondate )) || '"}'
		 from programstageinstance _psi where _psi.programstageinstanceid=hivtestingevent.programstageinstanceid ) as hivtesting_event

-- TEI UID
, tei_client.uid

, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid and _tea.uid='rw3W9pDCPb2'
				where tei_client.trackedentityinstanceid=_teav.trackedentityinstanceid ) as cuic

-- Counsil of Residence
, ( select '{"name":"' || optval.name || '","code":"' || optval.code || '"}' from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid and _tea.uid='NLNTtpbT3c5'
				INNER JOIN optionset optset on optset.optionsetid=_tea.optionsetid
				INNER JOIN optionvalue optval on optval.optionsetid=optset.optionsetid
				where tei_client.trackedentityinstanceid=_teav.trackedentityinstanceid and optval.code=_teav.value ) as tei_counsil

-- Heath Facility in [ART Opening] event
, ( select array_to_string(array_agg( '{"eventId":"' || _psi.uid || '","dataValue":"' || _tedv.value || '","deId":"' || de.uid  || '","eventDate":"' || _psi.executiondate || '","username":"' || catOption.code || '"}' ), ',')
		from trackedentitydatavalue as _tedv
				inner join programstageinstance _psi on _psi.programstageinstanceid=_tedv.programstageinstanceid
				inner join programinstance _pi on _pi.programinstanceid=_psi.programinstanceid
				inner join programstage _pgs on _pgs.programstageid=_psi.programstageid and _pgs.uid='OSpZnLBMVhr'
				inner join dataelement de on de.dataelementid=_tedv.dataelementid and ( de.uid='E1KAxdya3y5' or de.uid='CLclHLxzl9e' )
				INNER JOIN optionset optset on optset.optionsetid=de.optionsetid
				INNER JOIN optionvalue optval on optval.optionsetid=optset.optionsetid
				inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=_psi.attributeoptioncomboid
				inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid 
		where _pi.trackedentityinstanceid=tei_client.trackedentityinstanceid  ) as artopening_event


-- [Contact Log] event
, ( select array_to_string(array_agg( '{"eventId":"' || _psi.uid || '","datavalue":"' || _tedv.value || '", "deId":"' || de.uid  || '","eventDate":"' || _psi.executiondate || '","username":"' || catOption.code || '"}' ), ',')
		from trackedentitydatavalue as _tedv
				inner join programstageinstance _psi on _psi.programstageinstanceid=_tedv.programstageinstanceid
				inner join programinstance _pi on _psi.programinstanceid=_pi.programinstanceid
				inner join programstage _pgs on _pgs.programstageid=_psi.programstageid and _pgs.uid='gmBozy0KAMC'
				inner join dataelement de on de.dataelementid=_tedv.dataelementid
				inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=_psi.attributeoptioncomboid
				inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid 	
		where _pi.trackedentityinstanceid=tei_client.trackedentityinstanceid
 ) as contactlog_event



-- [Closure ART Refer] event
, ( select array_to_string(array_agg( '{"eventId":"' || _psi.uid || '","datavalue":"' || _tedv.value || '","eventDate":"' || _psi.executiondate || '","username":"' || catOption.code || '"}' ), ',')
		from programstageinstance _psi
				inner join programinstance _pi on _psi.programinstanceid=_pi.programinstanceid
				inner join programstage _pgs on _pgs.programstageid=_psi.programstageid and _pgs.uid='usEIFQODMxf'
				inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=_psi.attributeoptioncomboid
				inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid 
				inner join trackedentitydatavalue _tedv on _tedv.programstageinstanceid=_psi.programstageinstanceid
				inner join dataelement _de on _de.dataelementid=_tedv.dataelementid and _de.uid = 'nOK8JcDWT9X'
		where _pi.trackedentityinstanceid=tei_client.trackedentityinstanceid
		) as artclosure_event

from trackedentityinstance as tei_client
	inner join programinstance as pi_client
			on tei_client.trackedentityinstanceid = pi_client.trackedentityinstanceid
	inner join programstageinstance as hivtestingevent
			on pi_client.programinstanceid = hivtestingevent.programinstanceid
	inner join program as prg 
			on prg.programid = pi_client.programid
  

where prg.uid='KDgzpKX3h2S' 

and hivtestingevent.programstageinstanceid in (
		select _tedv.programstageinstanceid from trackedentitydatavalue _tedv 
				INNER JOIN dataelement _de on _de.dataelementid=_tedv.dataelementid
					and _de.uid='UuKat0HFjWS' and _tedv.value='Positive' )

group by 2,3,4,5,6,7,8






--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_ARTRefer_FollowUp

select DISTINCT ON(pi.programinstanceid)
 tei.uid, psi.uid, psi.executiondate

, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='rw3W9pDCPb2' ) as cuic

, ( select optval.name from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
				INNER JOIN optionset optset on optset.optionsetid=_tea.optionsetid
				INNER JOIN optionvalue optval on optval.optionsetid=optset.optionsetid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='mYdfuRItatP' and optval.code=_teav.value ) as referralstatus

, ( select optval.name from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
				INNER JOIN optionset optset on optset.optionsetid=_tea.optionsetid
				INNER JOIN optionvalue optval on optval.optionsetid=optset.optionsetid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='NLNTtpbT3c5' and optval.code=_teav.value ) as counsil

, artopeningfacility.value as facility
, R9Lw1uNtRuj.value as lastaction
, R9Lw1uNtRuj.executiondate as lastactiondate
, nextaction.value as nextaction
, nextactionduedate.value as nextactiondate
, extract(day from (
    date 'now()' - artopeningfacility.executiondate 
) )  as daySinceDiagnosis
, artclosureeventdata.programstageinstanceid as 	artclosureeventid
, artclosureeventdata.username as artclosureusername
, R9Lw1uNtRuj.username as contactlogeventusername

from programstageinstance psi
inner join organisationunit org on org.organisationunitid=psi.organisationunitid
inner join programinstance pi on pi.programinstanceid=psi.programinstanceid
inner join trackedentityinstance tei on tei.trackedentityinstanceid=pi.trackedentityinstanceid

left outer join ( select optval.name as value, _pi.programinstanceid, _psi.executiondate
		from trackedentitydatavalue as artopeningevent
				inner join programstageinstance _psi on _psi.programstageinstanceid=artopeningevent.programstageinstanceid
				inner join programinstance _pi on _psi.programinstanceid=_pi.programinstanceid
				inner join dataelement de on de.dataelementid=artopeningevent.dataelementid and de.uid = 'E1KAxdya3y5' 
				INNER JOIN optionset optset on optset.optionsetid=de.optionsetid
				INNER JOIN optionvalue optval on optval.optionsetid=optset.optionsetid and optval.code=artopeningevent.value ) as artopeningfacility
	on artopeningfacility.programinstanceid=pi.programinstanceid



left outer join ( select _pi.programinstanceid, _psi.programstageinstanceid, _psi.executiondate, catOption.code as username
		from programstageinstance _psi
				inner join programinstance _pi on _psi.programinstanceid=_pi.programinstanceid
				inner join programstage _pgs on _pgs.programstageid=_psi.programstageid and _pgs.uid='usEIFQODMxf'
				inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=_psi.attributeoptioncomboid
				inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
				inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid 
		) as artclosureeventdata
	on artclosureeventdata.programinstanceid=pi.programinstanceid


left outer join ( select contactlog.value, _pi.programinstanceid, _psi.executiondate, catOption.code as username
		from trackedentitydatavalue as contactlog
				inner join programstageinstance _psi on _psi.programstageinstanceid=contactlog.programstageinstanceid
				inner join programinstance _pi on _psi.programinstanceid=_pi.programinstanceid
				inner join dataelement de on de.dataelementid=contactlog.dataelementid
				inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=_psi.attributeoptioncomboid
				inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
				inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid
					and de.uid = 'wzM3bUiPowS' ) as R9Lw1uNtRuj
	on R9Lw1uNtRuj.programinstanceid=pi.programinstanceid


left outer join ( select contactlog.value, _pi.programinstanceid 
		from trackedentitydatavalue as contactlog
				inner join programstageinstance _psi on _psi.programstageinstanceid=contactlog.programstageinstanceid
				inner join programinstance _pi on _psi.programinstanceid=_pi.programinstanceid
				inner join dataelement de on de.dataelementid=contactlog.dataelementid
					and de.uid = 'mcgzEFh5IV8' ) as nextaction
	on nextaction.programinstanceid=pi.programinstanceid


left outer join ( select contactlog.value, _pi.programinstanceid 
		from trackedentitydatavalue as contactlog
				inner join programstageinstance _psi on _psi.programstageinstanceid=contactlog.programstageinstanceid
				inner join programinstance _pi on _psi.programinstanceid=_pi.programinstanceid
				inner join dataelement de on de.dataelementid=contactlog.dataelementid
					and de.uid = 'HcBFZsCt8Sy' ) as nextactionduedate
	on nextactionduedate.programinstanceid=pi.programinstanceid


 where ( ( R9Lw1uNtRuj.executiondate >= '${startDate}' and R9Lw1uNtRuj.executiondate < '${endDate}' ) or ( artclosureeventdata.executiondate >= '${startDate}' and artclosureeventdata.executiondate < '${endDate}' ) )
 	and psi.programstageid in ( select _ps.programstageid 
				from programstage _ps where _ps.uid = '${stageId}' )
	and ( R9Lw1uNtRuj.value is not null or artclosureeventdata.programstageinstanceid is not null )
  and ( artclosureeventdata.username ='${username}' or R9Lw1uNtRuj.username ='${username}' )
ORDER  BY pi.programinstanceid, psi.executiondate DESC 


/* 
 where psi.executiondate >= '2017-05-01' and psi.executiondate < '2017-06-06'
 	and psi.programstageid in ( select _ps.programstageid 
				from programstage _ps where _ps.uid = 'lVglvBnE3TY' )
	and ( R9Lw1uNtRuj.value is not null or artclosureeventdata.programstageinstanceid is not null )
--	and ( artclosureeventdata.username ='TES002' or R9Lw1uNtRuj.username ='TES002' )
ORDER  BY pi.programinstanceid, psi.executiondate DESC
 */




--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_FindFirstClientInCouple

select psi.uid, tei.uid as clientid , psi.executiondate
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='rw3W9pDCPb2' ) as cuic
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='R9Lw1uNtRuj' ) as firstname
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='TBt2a4Bq0Lx' ) as lastname
, finaltesttesultdata.value as finaltest
					
from programstageinstance psi
inner join organisationunit org on org.organisationunitid=psi.organisationunitid
inner join programinstance pi on pi.programinstanceid=psi.programinstanceid
inner join trackedentityinstance tei on tei.trackedentityinstanceid=pi.trackedentityinstanceid
inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=psi.attributeoptioncomboid
inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid
inner join programstage pgs on  pgs.programstageid=psi.programstageid

left outer join ( select couplecuicoption.value, couplecuicoption.programstageinstanceid 
		from trackedentitydatavalue as couplecuicoption
				inner join dataelement de on de.dataelementid=couplecuicoption.dataelementid
					and de.uid = 'csHM60DUGkG' ) as coupleoption
	on coupleoption.programstageinstanceid=psi.programstageinstanceid
	
	
left outer join ( select couplecuicoption.value, couplecuicoption.programstageinstanceid 
		from trackedentitydatavalue as couplecuicoption
				inner join dataelement de on de.dataelementid=couplecuicoption.dataelementid
					and de.uid = 'UYyCL2xz8Wz' ) as partner
	on partner.programstageinstanceid=psi.programstageinstanceid
		
left outer join ( select finaltestresult.value, finaltestresult.programstageinstanceid 
		from trackedentitydatavalue as finaltestresult
				inner join dataelement de on de.dataelementid=finaltestresult.dataelementid
					and de.uid = 'UuKat0HFjWS' ) as finaltesttesultdata
	on finaltesttesultdata.programstageinstanceid=psi.programstageinstanceid

where psi.executiondate >= '${startDate}' and psi.executiondate < '${endDate}' 
 	and pgs.uid = '${stageId}'
	and catOption.code='${username}'
	and org.uid='${ouId}'
	and coupleoption.value = '1'
and partner.value is null





--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_loadCases

select DISTINCT ON(pi.programinstanceid)
 tei_client.uid as clientuid, psi.uid as eventuid, psi.executiondate, finaltesttesultdata.value
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where tei_client.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='rw3W9pDCPb2' ) as cuic

, ( select COUNT(_psi.programstageinstanceid) 
			from programstageinstance _psi
					inner join programinstance _pi on _pi.programinstanceid=_psi.programinstanceid
					inner join programstage _prgs on _prgs.programstageid=_psi.programstageid
			where _pi.programinstanceid=pi.programinstanceid
					and _prgs.uid='${stageId}' ) as noevent
, org.name

, psi.status

, ( select count(*)
			from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
					and _tea.uid in ( 'ZQiKIaeOKv4', 'Rl2hRelrfur', 'qynN2cqRe71', 'NLNTtpbT3c5', 'VRUFmF5tE7b' )
			where tei_client.trackedentityinstanceid=_teav.trackedentityinstanceid ) as contactlog_info

-- Heath Facility in [ART Opening] event
, artopening_event.programstageinstanceid

, artchecked.value

-- Heath Facility in [PrEP Refer Opening] event
, prepreferopening_event.programstageinstanceid


from programstageinstance psi
inner join organisationunit org on org.organisationunitid=psi.organisationunitid
inner join programinstance pi on pi.programinstanceid=psi.programinstanceid
inner join trackedentityinstance tei_client on tei_client.trackedentityinstanceid=pi.trackedentityinstanceid
inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=psi.attributeoptioncomboid
inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid 
inner join program as prg on prg.programid = pi.programid


left outer join ( select finaltestresult.value, finaltestresult.programstageinstanceid 
		from trackedentitydatavalue as finaltestresult
				inner join dataelement de on de.dataelementid=finaltestresult.dataelementid
					and de.uid = 'UuKat0HFjWS' ) as finaltesttesultdata
	on finaltesttesultdata.programstageinstanceid=psi.programstageinstanceid

left outer join ( select finaltestresult.value, finaltestresult.programstageinstanceid 
		from trackedentitydatavalue as finaltestresult
				inner join dataelement de on de.dataelementid=finaltestresult.dataelementid
					and de.uid = 'tUIkmIFMEDS' ) as artchecked
	on artchecked.programstageinstanceid=psi.programstageinstanceid

left outer join ( select _psi.programinstanceid, _psi.programstageinstanceid
		from programstageinstance _psi
				inner join programstage _pgs on _pgs.programstageid=_psi.programstageid and _pgs.uid='OSpZnLBMVhr'
 ) as artopening_event on  artopening_event.programinstanceid=pi.programinstanceid


left outer join ( select _psi.programinstanceid, _psi.programstageinstanceid
		from programstageinstance _psi
				inner join programstage _pgs on _pgs.programstageid=_psi.programstageid and _pgs.uid='R5UixJ6WEAn'
 ) as prepreferopening_event on  prepreferopening_event.programinstanceid=pi.programinstanceid

where psi.executiondate >= '${startDate}' and psi.executiondate < '${endDate}'
 	and psi.programstageid in ( select _ps.programstageid 
				from programstage _ps where _ps.uid = '${stageId}' )
	and catOption.code='${username}'


ORDER  BY pi.programinstanceid, psi.executiondate DESC



--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_loadEventsbyCUIC


select tei.uid as clientId
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where tei.trackedentityinstanceid=_teav.trackedentityinstanceid
					and _tea.uid='mW2l3T2zL0N' ) as firstname
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where tei.trackedentityinstanceid=_teav.trackedentityinstanceid
					and _tea.uid='mUxDHgywnn2' ) as lastname
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where tei.trackedentityinstanceid=_teav.trackedentityinstanceid
					and _tea.uid='wSp6Q7QDMsk' ) as dateOfBirth	
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where tei.trackedentityinstanceid=_teav.trackedentityinstanceid
					and _tea.uid='u57uh7lHwF8' ) as districtOfBirth	
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where tei.trackedentityinstanceid=_teav.trackedentityinstanceid
					and _tea.uid='vTPYC9BXPNn' ) as birthOrder
, array_to_string(array( SELECT _psi.uid || '*' || _psi.executiondate FROM programstageinstance _psi 
	INNER JOIN programinstance _pi on _pi.programinstanceid=_psi.programinstanceid 
	WHERE _pi.trackedentityinstanceid=tei.trackedentityinstanceid ), ', ' ) as eventDateList

from trackedentityinstance tei 
inner join psi_view_trackedentityattributevalue teav on tei.trackedentityinstanceid=teav.trackedentityinstanceid
inner join psi_view_trackedentityattribute tea on tea.trackedentityattributeid=teav.trackedentityattributeid
inner join programinstance pi on pi.trackedentityinstanceid=tei.trackedentityinstanceid
inner join program prg on prg.programid=pi.programid
where prg.uid='KDgzpKX3h2S' and tea.uid='zRA08XEYiSF' and teav.value='${cuic}'
order by tei.created desc



--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_loadPartnerByEventId

select psi.uid, tei.uid as clientid , psi.executiondate
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='rw3W9pDCPb2' ) as cuic
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='R9Lw1uNtRuj' ) as firstname
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='TBt2a4Bq0Lx' ) as lastname
, finaltesttesultdata.value as finaltest
					
from programstageinstance psi
inner join organisationunit org on org.organisationunitid=psi.organisationunitid
inner join programinstance pi on pi.programinstanceid=psi.programinstanceid
inner join trackedentityinstance tei on tei.trackedentityinstanceid=pi.trackedentityinstanceid
inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=psi.attributeoptioncomboid
inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid
inner join programstage pgs on  pgs.programstageid=psi.programstageid

left outer join ( select couplecuicoption.value, couplecuicoption.programstageinstanceid 
		from trackedentitydatavalue as couplecuicoption
				inner join dataelement de on de.dataelementid=couplecuicoption.dataelementid
					and de.uid = 'csHM60DUGkG' ) as coupleoption
	on coupleoption.programstageinstanceid=psi.programstageinstanceid
	
	
left outer join ( select couplecuicoption.value, couplecuicoption.programstageinstanceid 
		from trackedentitydatavalue as couplecuicoption
				inner join dataelement de on de.dataelementid=couplecuicoption.dataelementid
					and de.uid = 'UYyCL2xz8Wz' ) as partner
	on partner.programstageinstanceid=psi.programstageinstanceid
		
left outer join ( select finaltestresult.value, finaltestresult.programstageinstanceid 
		from trackedentitydatavalue as finaltestresult
				inner join dataelement de on de.dataelementid=finaltestresult.dataelementid
					and de.uid = 'UuKat0HFjWS' ) as finaltesttesultdata
	on finaltesttesultdata.programstageinstanceid=psi.programstageinstanceid

where psi.uid = '${partnerEventId}'




--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_PositiveCases


select -- DISTINCT ON(psi.organisationunitid, psi.programstageid)
 tei.uid, psi.uid, psi.executiondate, finaltesttesultdata.value
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='rw3W9pDCPb2' ) as cuic

, ( select COUNT(_psi.programstageinstanceid) 
			from programstageinstance _psi
					inner join programinstance _pi on _pi.programinstanceid=_psi.programinstanceid
					inner join programstage _prgs on _prgs.programstageid=_psi.programstageid
			where _pi.programinstanceid=pi.programinstanceid
					and _prgs.uid='${stageId}' ) as noevent
, org.name

, ( select optval.name from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
				INNER JOIN optionset opts on opts.optionsetid=_tea.optionsetid
				INNER JOIN optionvalue optval on optval.optionsetid=opts.optionsetid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='mYdfuRItatP' and _teav.value=optval.code ) as artstatus

, ( select DISTINCT on ( optval.name ) optval.name from trackedentitydatavalue _tedv 
				INNER JOIN dataelement _de on _de.dataelementid=_tedv.dataelementid
				inner join programstageinstance _psi on _tedv.programstageinstanceid=_psi.programstageinstanceid
				INNER JOIN optionset opts on opts.optionsetid=_de.optionsetid
				INNER JOIN optionvalue optval on optval.optionsetid=opts.optionsetid
		where _psi.programinstanceid=pi.programinstanceid
					and _de.uid='E1KAxdya3y5' and _tedv.value=optval.code ) as artopeningfacility



from programstageinstance psi
inner join organisationunit org on org.organisationunitid=psi.organisationunitid
inner join programinstance pi on pi.programinstanceid=psi.programinstanceid
inner join trackedentityinstance tei on tei.trackedentityinstanceid=pi.trackedentityinstanceid
inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=psi.attributeoptioncomboid
inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid


left outer join ( select finaltestresult.value, finaltestresult.programstageinstanceid 
		from trackedentitydatavalue as finaltestresult
				inner join dataelement de on de.dataelementid=finaltestresult.dataelementid
					and de.uid = 'UuKat0HFjWS' ) as finaltesttesultdata
	on finaltesttesultdata.programstageinstanceid=psi.programstageinstanceid



/* 
where psi.executiondate >= '2017-01-01' and psi.executiondate < '2017-07-01'
 	and psi.programstageid in ( select _ps.programstageid 
				from programstage _ps where _ps.uid = 'lVglvBnE3TY' )
	and catOption.code='TES001'
*/

 where psi.executiondate >= '${startDate}' and psi.executiondate < '${endDate}'
 	and psi.programstageid in ( select _ps.programstageid 
				from programstage _ps where _ps.uid = '${stageId}' )
	and catOption.code='${username}'



	and psi.programstageinstanceid in (
		select _tedv.programstageinstanceid from trackedentitydatavalue _tedv 
				INNER JOIN dataelement _de on _de.dataelementid=_tedv.dataelementid
					and _de.uid='UuKat0HFjWS' and _tedv.value='Positive'
	)

ORDER  BY psi.organisationunitid, psi.programstageid, psi.executiondate DESC




--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_searchClients


select tei_client.uid

, ( CASE WHEN ( "R9Lw1uNtRuj".value is null ) THEN ' ' ELSE ' ' || "R9Lw1uNtRuj".value END ) as firstname
, ( CASE WHEN ( "TBt2a4Bq0Lx".value is null ) THEN ' ' ELSE ' ' || "TBt2a4Bq0Lx".value END ) as lastname
, ( CASE WHEN ( "BvsJfkddTgZ".value is null ) THEN ' ' ELSE ' ' || "BvsJfkddTgZ".value END ) as birthdate
, ( CASE WHEN ( "u57uh7lHwF8".value is null ) THEN ' ' ELSE ' ' || "u57uh7lHwF8".value END ) as birthdistrict
, ( CASE WHEN ( "vTPYC9BXPNn".value is null ) THEN ' ' ELSE ' ' || "vTPYC9BXPNn".value END ) as birthorder
, pi_client.enrollmentdate
, max( latest_event.executiondate ) as latestevent

from trackedentityinstance as tei_client

inner join programinstance as pi_client
	on tei_client.trackedentityinstanceid = pi_client.trackedentityinstanceid

left outer join programstageinstance as latest_event
	on pi_client.programinstanceid = latest_event.programinstanceid

inner join program as prg 
	on prg.programid = pi_client.programid

-- firstname
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='R9Lw1uNtRuj' ) as "R9Lw1uNtRuj"
	on "R9Lw1uNtRuj".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- lastname
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='TBt2a4Bq0Lx' ) as "TBt2a4Bq0Lx" 
	on "TBt2a4Bq0Lx".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- birthdate
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='BvsJfkddTgZ' ) as "BvsJfkddTgZ" 
	on "BvsJfkddTgZ".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- district
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='u57uh7lHwF8' ) as "u57uh7lHwF8" 
	on "u57uh7lHwF8".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- birth order
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='vTPYC9BXPNn' ) as "vTPYC9BXPNn" -- district
	on "vTPYC9BXPNn".trackedentityinstanceid = tei_client.trackedentityinstanceid

where prg.uid='KDgzpKX3h2S' 

and  ( CASE WHEN ( "R9Lw1uNtRuj".value is null ) THEN ' ' ELSE ' ' || "R9Lw1uNtRuj".value END ) ilike '%${R9Lw1uNtRuj}%'
and  ( CASE WHEN ( "TBt2a4Bq0Lx".value is null ) THEN ' ' ELSE ' ' || "TBt2a4Bq0Lx".value END ) ilike '%${TBt2a4Bq0Lx}%'
and  ( CASE WHEN ( "BvsJfkddTgZ".value is null ) THEN ' ' ELSE ' ' || "BvsJfkddTgZ".value END ) ilike '%${BvsJfkddTgZ}%' 
and  ( CASE WHEN ( "u57uh7lHwF8".value is null ) THEN ' ' ELSE ' ' || "u57uh7lHwF8".value END ) ilike '%${u57uh7lHwF8}%'
and  ( CASE WHEN ( "vTPYC9BXPNn".value is null ) THEN ' ' ELSE ' ' || "vTPYC9BXPNn".value END ) ilike '%${vTPYC9BXPNn}%'

group by tei_client.uid, "R9Lw1uNtRuj".value, "TBt2a4Bq0Lx".value
, "BvsJfkddTgZ".value, "u57uh7lHwF8".value
, "vTPYC9BXPNn".value, pi_client.enrollmentdate, tei_client.created

ORDER BY tei_client.created




--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_SearchPositiveClient


select tei_client.uid

, ( CASE WHEN ( "R9Lw1uNtRuj".value is null ) THEN ' ' ELSE ' ' || "R9Lw1uNtRuj".value END ) as firstname
, ( CASE WHEN ( "TBt2a4Bq0Lx".value is null ) THEN ' ' ELSE ' ' || "TBt2a4Bq0Lx".value END ) as lastname
, ( CASE WHEN ( "BvsJfkddTgZ".value is null ) THEN ' ' ELSE ' ' || "BvsJfkddTgZ".value END ) as birthdate
, ( CASE WHEN ( "u57uh7lHwF8".value is null ) THEN ' ' ELSE ' ' || "u57uh7lHwF8".value END ) as birthdistrict
, ( CASE WHEN ( "vTPYC9BXPNn".value is null ) THEN ' ' ELSE ' ' || "vTPYC9BXPNn".value END ) as birthorder
, pi_client.enrollmentdate
, max( event.executiondate ) as event

from trackedentityinstance as tei_client

inner join programinstance as pi_client
	on tei_client.trackedentityinstanceid = pi_client.trackedentityinstanceid

left outer join programstageinstance as event
	on pi_client.programinstanceid = event.programinstanceid

inner join program as prg 
	on prg.programid = pi_client.programid

-- firstname
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='R9Lw1uNtRuj' ) as "R9Lw1uNtRuj"
	on "R9Lw1uNtRuj".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- lastname
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='TBt2a4Bq0Lx' ) as "TBt2a4Bq0Lx" 
	on "TBt2a4Bq0Lx".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- birthdate
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='BvsJfkddTgZ' ) as "BvsJfkddTgZ" 
	on "BvsJfkddTgZ".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- district
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='u57uh7lHwF8' ) as "u57uh7lHwF8" 
	on "u57uh7lHwF8".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- birth order
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='vTPYC9BXPNn' ) as "vTPYC9BXPNn" -- district
	on "vTPYC9BXPNn".trackedentityinstanceid = tei_client.trackedentityinstanceid


where prg.uid='KDgzpKX3h2S' 

and  ( CASE WHEN ( "R9Lw1uNtRuj".value is null ) THEN ' ' ELSE ' ' || "R9Lw1uNtRuj".value END ) ilike '%${R9Lw1uNtRuj}%'
and  ( CASE WHEN ( "TBt2a4Bq0Lx".value is null ) THEN ' ' ELSE ' ' || "TBt2a4Bq0Lx".value END ) ilike '%${TBt2a4Bq0Lx}%'
and  ( CASE WHEN ( "BvsJfkddTgZ".value is null ) THEN ' ' ELSE ' ' || "BvsJfkddTgZ".value END ) ilike '%${BvsJfkddTgZ}%' 
and  ( CASE WHEN ( "u57uh7lHwF8".value is null ) THEN ' ' ELSE ' ' || "u57uh7lHwF8".value END ) ilike '%${u57uh7lHwF8}%'
and  ( CASE WHEN ( "vTPYC9BXPNn".value is null ) THEN ' ' ELSE ' ' || "vTPYC9BXPNn".value END ) ilike '%${vTPYC9BXPNn}%'

and event.programstageinstanceid in (
		select _tedv.programstageinstanceid from trackedentitydatavalue _tedv 
				INNER JOIN dataelement _de on _de.dataelementid=_tedv.dataelementid
					and _de.uid='UuKat0HFjWS' and _tedv.value='Positive'
	)
	
group by tei_client.uid, "R9Lw1uNtRuj".value, "TBt2a4Bq0Lx".value
, "BvsJfkddTgZ".value, "u57uh7lHwF8".value
, "vTPYC9BXPNn".value, pi_client.enrollmentdate, tei_client.created

ORDER BY tei_client.created




