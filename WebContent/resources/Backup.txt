
--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_ARTRefer_AllFollowUp


select tei.uid

, cuic.value

, ''

, ''

, extract(day from (
    date 'now()' - openartevent.executiondate 
) ) as daySinceDiagnosis 

, counsil.value

, openartevent.uid
, openartevent.executiondate

, facility.value
, otherfacility.value

, contactevent.executiondate as lasteventdate
, _tedv_lastactionname.value
, _tedv_nextactionduedate.value
, _tedv_nextactionname.value
, contacteventwithusername.count

, _openartevent_username.username

, closearteventwithusername.executiondate
, closearteventwithusername.username
, closearteventwithusername.value


from trackedentityinstance tei
inner join programinstance pi 
			on pi.trackedentityinstanceid=tei.trackedentityinstanceid
inner join programstageinstance openartevent
			on openartevent.programinstanceid=pi.programinstanceid
inner join programstage stage 		
			on stage.uid='OSpZnLBMVhr'
					and stage.programid=pi.programid and openartevent.programstageid=stage.programstageid

----------------------- HIV Test date -----------------------
/*
inner join ( select hivtest.executiondate, hivtest.programstageinstanceid, hivtest.programinstanceid 
    from programstageinstance hivtest
		inner join programstage _stage 
			on _stage.programstageid = hivtest.programstageid and _stage.uid='lVglvBnE3TY' 
		inner join trackedentitydatavalue _tedv on _tedv.programstageinstanceid=hivtest.programstageinstanceid
		INNER JOIN dataelement _de on _de.dataelementid=_tedv.dataelementid
					and _de.uid='UuKat0HFjWS' and _tedv.value='Positive'
		-- order by hivtest.executiondate desc limit 1 
) as hivtestevent 
	on pi.programinstanceid = hivtestevent.programinstanceid 
*/
-- ===================================

left outer join ( select _teav.value, _teav.trackedentityinstanceid  from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where _tea.uid='rw3W9pDCPb2' ) as cuic on tei.trackedentityinstanceid=cuic.trackedentityinstanceid 

left outer join ( select _teav.value, _teav.trackedentityinstanceid  from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where _tea.uid='NLNTtpbT3c5' ) as counsil on tei.trackedentityinstanceid=counsil.trackedentityinstanceid 
----------------------- Opening user created -----------------------


left outer join ( select catOption.code as username, _openartevent.programstageinstanceid
    from programstageinstance _openartevent 
		inner join programstage _stage 
			on _stage.programstageid = _openartevent.programstageid and _stage.uid='gmBozy0KAMC' 
		inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=_openartevent.attributeoptioncomboid
		inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
		inner join dataelementcategoryoption catOption 
			on catOption.categoryoptionid=catoptrls.categoryoptionid 
		where catOption.code = 'TES002' 
		group by catOption.code, _openartevent.programstageinstanceid
  ) as _openartevent_username 
	on _openartevent_username.programstageinstanceid = openartevent.programstageinstanceid 

----------------------- latest contact log event -----------------------

left outer join 
 ( select DISTINCT ON (eventlatest.programinstanceid) eventlatest.programinstanceid, eventlatest.programstageinstanceid, eventlatest.executiondate
   from programstageinstance as eventlatest
   inner join programstage _stage 
    on _stage.programstageid = eventlatest.programstageid 
    and _stage.uid='gmBozy0KAMC' 
   order by eventlatest.programinstanceid, eventlatest.executiondate desc
 ) as contactevent -- contactevent_latest
 on pi.programinstanceid = contactevent.programinstanceid



/*
-- Sandox
left outer join trackedentitydatavalue _tedv_lastactionname
  on _tedv_lastactionname.dataelementid = 942514 -- IDs are different beteen servers ( wzM3bUiPowS )
		and contactevent.programstageinstanceid = _tedv_lastactionname.programstageinstanceid 


left outer join trackedentitydatavalue _tedv_nextactionname
  on _tedv_nextactionname.dataelementid = 942516 -- IDs are different beteen servers ( mcgzEFh5IV8 )
		and contactevent.programstageinstanceid = _tedv_nextactionname.programstageinstanceid 

left outer join trackedentitydatavalue _tedv_nextactionduedate
  on _tedv_nextactionduedate.dataelementid = 967606 -- IDs are different beteen servers ( HcBFZsCt8Sy )
		and contactevent.programstageinstanceid = _tedv_nextactionduedate.programstageinstanceid 

*/

-- production server
left outer join trackedentitydatavalue _tedv_lastactionname
  on _tedv_lastactionname.dataelementid = 101243548 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_lastactionname.programstageinstanceid 


left outer join trackedentitydatavalue _tedv_nextactionname
  on _tedv_nextactionname.dataelementid = 101243547 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_nextactionname.programstageinstanceid 

left outer join trackedentitydatavalue _tedv_nextactionduedate
  on _tedv_nextactionduedate.dataelementid = 101243553 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_nextactionduedate.programstageinstanceid 



----------------------- Check Contact log event with username -----------------------

left outer join ( select count( contactlogevent.executiondate ) as count, contactlogevent.programinstanceid
    from programstageinstance contactlogevent 
		inner join programstage _stage 
			on _stage.programstageid = contactlogevent.programstageid and _stage.uid='gmBozy0KAMC' 
		inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=contactlogevent.attributeoptioncomboid
		inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
		inner join dataelementcategoryoption catOption 
			on catOption.categoryoptionid=catoptrls.categoryoptionid 
		where catOption.code = 'TES002'  --  
		group by contactlogevent.programinstanceid
  ) as contacteventwithusername 
	on pi.programinstanceid = contacteventwithusername.programinstanceid 

left outer join ( select catOption.code as username, _tedv.value, closeartevent.programinstanceid, closeartevent.executiondate
    from programstageinstance closeartevent
		inner join programstage _stage 
			on _stage.programstageid = closeartevent.programstageid and _stage.uid='usEIFQODMxf' 
		inner join trackedentitydatavalue _tedv 
			on _tedv.programstageinstanceid=closeartevent.programstageinstanceid
		inner join dataelement _de 
			on _de.dataelementid=_tedv.dataelementid and _de.uid = 'nOK8JcDWT9X'
		inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=closeartevent.attributeoptioncomboid
		inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
		inner join dataelementcategoryoption catOption 
			on catOption.categoryoptionid=catoptrls.categoryoptionid 
  ) as closearteventwithusername 
	on pi.programinstanceid = closearteventwithusername.programinstanceid 

------------------------- Facility in Opening event -------------------------

-- Facility
left outer join ( select _tedv.value, _psi.programinstanceid
		from trackedentitydatavalue as _tedv
				inner join programstageinstance _psi on _psi.programstageinstanceid = _tedv.programstageinstanceid
				inner join programstage _pgs on _pgs.programstageid=_psi.programstageid and _pgs.uid='OSpZnLBMVhr'
				inner join dataelement de on de.dataelementid = _tedv.dataelementid and de.uid='E1KAxdya3y5' 
	) as facility on pi.programinstanceid = facility.programinstanceid


-- Other facility name
left outer join ( select _tedv.value, _psi.programinstanceid
		from trackedentitydatavalue as _tedv
				inner join programstageinstance _psi on _psi.programstageinstanceid = _tedv.programstageinstanceid
				inner join programstage _pgs on _pgs.programstageid=_psi.programstageid and _pgs.uid='OSpZnLBMVhr'
				inner join dataelement de on de.dataelementid = _tedv.dataelementid and de.uid='CLclHLxzl9e' 
	) as otherfacility on pi.programinstanceid = otherfacility.programinstanceid



-- ===================================
-- where stage.uid='OSpZnLBMVhr'
-- where  cuic.value='991007SEMP04'
group by tei.uid, tei.trackedentityinstanceid, openartevent.executiondate, cuic.value, counsil.value
,contactevent.executiondate, _tedv_lastactionname.value, _tedv_nextactionname.value, _tedv_nextactionduedate.value
,contacteventwithusername.count, closearteventwithusername.username, facility.value
--, hivtestevent.programstageinstanceid
,openartevent.uid
--, hivtestevent.executiondate
,_openartevent_username.username
,closearteventwithusername.executiondate
,closearteventwithusername.value
,otherfacility.value



-- limit ${pageSize} offset ${offset};




--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_ARTRefer_FollowUp




select * from
( ( select tei.uid as cientid, hivtestevent.uid as hiveventid, hivtestevent.executiondate as hivtestate
, cuic.value as cuic
, referralstatus.value as referralstatusval
, counsil.value as counsilval
, facility.value
, contactevent.executiondate as lasteventdate
, _tedv_lastactionname.value
, _tedv_nextactionduedate.value
, _tedv_nextactionname.value
, extract(day from (
    date 'now()' - facility.executiondate 
) )  as daySinceDiagnosis


from programinstance pi
inner join trackedentityinstance tei on tei.trackedentityinstanceid=pi.trackedentityinstanceid

----------------------- HIV Test date -----------------------
inner join ( select hivtest.uid, hivtest.executiondate, hivtest.programinstanceid 
    from programstageinstance hivtest
		inner join programstage _stage 
			on _stage.programstageid = hivtest.programstageid and _stage.uid='lVglvBnE3TY' 
		order by hivtest.executiondate desc limit 1 
) as hivtestevent 
	on pi.programinstanceid = hivtestevent.programinstanceid 

----------------------- latest contact log event of current user -----------------------

inner join ( select contactlogevent.executiondate, contactlogevent.programinstanceid ,  contactlogevent.programstageinstanceid
    from programstageinstance contactlogevent 
		inner join programstage _stage on _stage.programstageid = contactlogevent.programstageid and _stage.uid='gmBozy0KAMC'
    inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=contactlogevent.attributeoptioncomboid
		inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
		inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid and catOption.code = '${username}'
		where contactlogevent.executiondate >= '${startDate}' and contactlogevent.executiondate < '${endDate}'
	  order by contactlogevent.executiondate desc limit 1 ) as contactevent 
	on pi.programinstanceid = contactevent.programinstanceid 

inner join trackedentitydatavalue _tedv_lastactionname
  on _tedv_lastactionname.dataelementid = 101243548 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_lastactionname.programstageinstanceid 


inner join trackedentitydatavalue _tedv_nextactionname
  on _tedv_nextactionname.dataelementid = 101243547 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_nextactionname.programstageinstanceid 

inner join trackedentitydatavalue _tedv_nextactionduedate
  on _tedv_nextactionduedate.dataelementid = 101243553 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_nextactionduedate.programstageinstanceid 


-- CUIC
left outer join ( select _teav.value, _teav.trackedentityinstanceid from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where _tea.uid='rw3W9pDCPb2' ) as cuic on tei.trackedentityinstanceid=cuic.trackedentityinstanceid 

-- Referral Status
left outer join ( select optval.name as value, _teav.trackedentityinstanceid from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN optionset optset on optset.optionsetid=_tea.optionsetid
				INNER JOIN optionvalue optval on optval.optionsetid=optset.optionsetid
			where _tea.uid='mYdfuRItatP' ) as referralstatus on tei.trackedentityinstanceid=referralstatus.trackedentityinstanceid

-- counsil
left outer join ( select _teav.value, _teav.trackedentityinstanceid  
      from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where _tea.uid='NLNTtpbT3c5' ) as counsil on tei.trackedentityinstanceid=counsil.trackedentityinstanceid

-- Opening Facility
left outer join ( select _tedv.value, _psi.programinstanceid, _psi.executiondate
		from trackedentitydatavalue as _tedv
				inner join programstageinstance _psi on _psi.programstageinstanceid = _tedv.programstageinstanceid
				inner join programstage _pgs on _pgs.programstageid=_psi.programstageid and _pgs.uid='OSpZnLBMVhr'
				inner join dataelement de on de.dataelementid = _tedv.dataelementid and de.uid='E1KAxdya3y5' 
	) as facility on pi.programinstanceid = facility.programinstanceid


group by tei.uid, hivtestevent.uid, hivtestevent.executiondate
, cuic.value
, referralstatus.value
, counsil.value
, facility.value
, facility.executiondate 
, contactevent.executiondate
, _tedv_lastactionname.value
, _tedv_nextactionduedate.value
, _tedv_nextactionname.value

ORDER BY hivtestevent.executiondate DESC
)

UNION
(

select tei.uid as cientid, hivtestevent.uid as hiveventid, hivtestevent.executiondate as hivtestate
, cuic.value as cuic
, referralstatus.value as referralstatusval
, counsil.value as counsilval
, facility.value
, contactevent.executiondate as lasteventdate
, _tedv_lastactionname.value
, _tedv_nextactionduedate.value
, _tedv_nextactionname.value
, extract(day from (
    date 'now()' - facility.executiondate 
) )  as daySinceDiagnosis



from programinstance pi 
inner join programstageinstance closeartevent on pi.programinstanceid=closeartevent.programinstanceid
inner join trackedentityinstance tei on tei.trackedentityinstanceid=pi.trackedentityinstanceid
inner join programstage _stage on _stage.programstageid = closeartevent.programstageid and _stage.uid='usEIFQODMxf' 
inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=closeartevent.attributeoptioncomboid
inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid and catOption.code = '${username}'


----------------------- HIV Test date -----------------------
inner join ( select hivtest.uid, hivtest.executiondate, hivtest.programinstanceid 
    from programstageinstance hivtest
		inner join programstage _stage on _stage.programstageid = hivtest.programstageid and _stage.uid='lVglvBnE3TY' 
		order by hivtest.executiondate desc limit 1 
) as hivtestevent 
	on pi.programinstanceid = hivtestevent.programinstanceid 


----------------------- latest contact log event of current user -----------------------

left outer join ( select contactlogevent.executiondate, contactlogevent.programinstanceid ,  contactlogevent.programstageinstanceid
    from programstageinstance contactlogevent 
		inner join programstage _stage on _stage.programstageid = contactlogevent.programstageid and _stage.uid='gmBozy0KAMC'
    inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=contactlogevent.attributeoptioncomboid
		inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
		inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid and catOption.code = '${username}'
		where contactlogevent.executiondate >= '${startDate}' and contactlogevent.executiondate < '${endDate}'
	  order by contactlogevent.executiondate desc limit 1 ) as contactevent 
	on pi.programinstanceid = contactevent.programinstanceid 

left outer join trackedentitydatavalue _tedv_lastactionname
  on _tedv_lastactionname.dataelementid = 101243548 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_lastactionname.programstageinstanceid 


left outer join trackedentitydatavalue _tedv_nextactionname
  on _tedv_nextactionname.dataelementid = 101243547 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_nextactionname.programstageinstanceid 

left outer join trackedentitydatavalue _tedv_nextactionduedate
  on _tedv_nextactionduedate.dataelementid = 101243553 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_nextactionduedate.programstageinstanceid 


-- CUIC
left outer join ( select _teav.value, _teav.trackedentityinstanceid from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where _tea.uid='rw3W9pDCPb2' ) as cuic on tei.trackedentityinstanceid=cuic.trackedentityinstanceid 

-- Referral Status
left outer join ( select optval.name as value, _teav.trackedentityinstanceid from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN optionset optset on optset.optionsetid=_tea.optionsetid
				INNER JOIN optionvalue optval on optval.optionsetid=optset.optionsetid
			where _tea.uid='mYdfuRItatP' ) as referralstatus on tei.trackedentityinstanceid=referralstatus.trackedentityinstanceid

-- counsil
left outer join ( select _teav.value, _teav.trackedentityinstanceid  
      from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where _tea.uid='NLNTtpbT3c5' ) as counsil on tei.trackedentityinstanceid=counsil.trackedentityinstanceid

-- Opening Facility
left outer join ( select _tedv.value, _psi.programinstanceid, _psi.executiondate
		from trackedentitydatavalue as _tedv
				inner join programstageinstance _psi on _psi.programstageinstanceid = _tedv.programstageinstanceid
				inner join programstage _pgs on _pgs.programstageid=_psi.programstageid and _pgs.uid='OSpZnLBMVhr'
				inner join dataelement de on de.dataelementid = _tedv.dataelementid and de.uid='E1KAxdya3y5' 
	) as facility on pi.programinstanceid = facility.programinstanceid


group by tei.uid, hivtestevent.uid, hivtestevent.executiondate
, cuic.value
, referralstatus.value
, counsil.value
, facility.value
, facility.executiondate 
, contactevent.executiondate
, _tedv_lastactionname.value
, _tedv_nextactionduedate.value
, _tedv_nextactionname.value


ORDER BY hivtestevent.executiondate DESC

) ) as todaycaseresult





--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_FindFirstClientInCouple

select psi.uid, tei.uid as clientid , psi.executiondate
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='rw3W9pDCPb2' ) as cuic
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='R9Lw1uNtRuj' ) as firstname
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='TBt2a4Bq0Lx' ) as lastname
, finaltesttesultdata.value as finaltest
					
from programstageinstance psi
inner join organisationunit org on org.organisationunitid=psi.organisationunitid
inner join programinstance pi on pi.programinstanceid=psi.programinstanceid
inner join trackedentityinstance tei on tei.trackedentityinstanceid=pi.trackedentityinstanceid
inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=psi.attributeoptioncomboid
inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid
inner join programstage pgs on  pgs.programstageid=psi.programstageid

left outer join ( select couplecuicoption.value, couplecuicoption.programstageinstanceid 
		from trackedentitydatavalue as couplecuicoption
				inner join dataelement de on de.dataelementid=couplecuicoption.dataelementid
					and de.uid = 'csHM60DUGkG' ) as coupleoption
	on coupleoption.programstageinstanceid=psi.programstageinstanceid
	
	
left outer join ( select couplecuicoption.value, couplecuicoption.programstageinstanceid 
		from trackedentitydatavalue as couplecuicoption
				inner join dataelement de on de.dataelementid=couplecuicoption.dataelementid
					and de.uid = 'UYyCL2xz8Wz' ) as partner
	on partner.programstageinstanceid=psi.programstageinstanceid
		
left outer join ( select finaltestresult.value, finaltestresult.programstageinstanceid 
		from trackedentitydatavalue as finaltestresult
				inner join dataelement de on de.dataelementid=finaltestresult.dataelementid
					and de.uid = 'UuKat0HFjWS' ) as finaltesttesultdata
	on finaltesttesultdata.programstageinstanceid=psi.programstageinstanceid

where psi.executiondate >= '${startDate}' and psi.executiondate < '${endDate}' 
 	and pgs.uid = '${stageId}'
	and catOption.code='${username}'
	and org.uid='${ouId}'
	and coupleoption.value = '1'
and partner.value is null





--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_loadCases


select DISTINCT ON(pi.programinstanceid)
 tei_client.uid, psi.uid, psi.executiondate, finaltesttesultdata.value
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where tei_client.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='rw3W9pDCPb2' ) as cuic

, ( select COUNT(_psi.programstageinstanceid) 
			from programstageinstance _psi
					inner join programinstance _pi on _pi.programinstanceid=_psi.programinstanceid
					inner join programstage _prgs on _prgs.programstageid=_psi.programstageid
			where _pi.programinstanceid=pi.programinstanceid
					and _prgs.uid='${stageId}' ) as noevent
, org.name

, psi.status

, ( select count(*)
			from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
					and _tea.uid in ( 'ZQiKIaeOKv4', 'Rl2hRelrfur', 'qynN2cqRe71', 'NLNTtpbT3c5', 'VRUFmF5tE7b' )
			where tei_client.trackedentityinstanceid=_teav.trackedentityinstanceid ) as contactlog_info

-- Heath Facility in [ART Opening] event
, artopening_event.programstageinstanceid

, artchecked.value


from programstageinstance psi
inner join organisationunit org on org.organisationunitid=psi.organisationunitid
inner join programinstance pi on pi.programinstanceid=psi.programinstanceid
inner join trackedentityinstance tei_client on tei_client.trackedentityinstanceid=pi.trackedentityinstanceid
inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=psi.attributeoptioncomboid
inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid 
inner join program as prg on prg.programid = pi.programid


left outer join ( select finaltestresult.value, finaltestresult.programstageinstanceid 
		from trackedentitydatavalue as finaltestresult
				inner join dataelement de on de.dataelementid=finaltestresult.dataelementid
					and de.uid = 'UuKat0HFjWS' ) as finaltesttesultdata
	on finaltesttesultdata.programstageinstanceid=psi.programstageinstanceid

left outer join ( select finaltestresult.value, finaltestresult.programstageinstanceid 
		from trackedentitydatavalue as finaltestresult
				inner join dataelement de on de.dataelementid=finaltestresult.dataelementid
					and de.uid = 'tUIkmIFMEDS' ) as artchecked
	on artchecked.programstageinstanceid=psi.programstageinstanceid

left outer join ( select _psi.programinstanceid, _psi.programstageinstanceid
		from programstageinstance _psi
				inner join programstage _pgs on _pgs.programstageid=_psi.programstageid and _pgs.uid='OSpZnLBMVhr'
 ) as artopening_event on  artopening_event.programinstanceid=pi.programinstanceid


where psi.executiondate >= '${startDate}' and psi.executiondate < '${endDate}'
 	and psi.programstageid in ( select _ps.programstageid 
				from programstage _ps where _ps.uid = '${stageId}' )
	and catOption.code='${username}'


ORDER  BY pi.programinstanceid, psi.executiondate DESC




--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_loadEventsbyCUIC


select tei.uid as clientId
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where tei.trackedentityinstanceid=_teav.trackedentityinstanceid
					and _tea.uid='mW2l3T2zL0N' ) as firstname
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where tei.trackedentityinstanceid=_teav.trackedentityinstanceid
					and _tea.uid='mUxDHgywnn2' ) as lastname
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where tei.trackedentityinstanceid=_teav.trackedentityinstanceid
					and _tea.uid='wSp6Q7QDMsk' ) as dateOfBirth	
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where tei.trackedentityinstanceid=_teav.trackedentityinstanceid
					and _tea.uid='u57uh7lHwF8' ) as districtOfBirth	
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where tei.trackedentityinstanceid=_teav.trackedentityinstanceid
					and _tea.uid='vTPYC9BXPNn' ) as birthOrder
, array_to_string(array( SELECT _psi.uid || '*' || _psi.executiondate FROM programstageinstance _psi 
	INNER JOIN programinstance _pi on _pi.programinstanceid=_psi.programinstanceid 
	WHERE _pi.trackedentityinstanceid=tei.trackedentityinstanceid ), ', ' ) as eventDateList

from trackedentityinstance tei 
inner join psi_view_trackedentityattributevalue teav on tei.trackedentityinstanceid=teav.trackedentityinstanceid
inner join psi_view_trackedentityattribute tea on tea.trackedentityattributeid=teav.trackedentityattributeid
inner join programinstance pi on pi.trackedentityinstanceid=tei.trackedentityinstanceid
inner join program prg on prg.programid=pi.programid
where prg.uid='KDgzpKX3h2S' and tea.uid='zRA08XEYiSF' and teav.value='${cuic}'
order by tei.created desc



--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_loadPartnerByEventId

select psi.uid, tei.uid as clientid , psi.executiondate
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='rw3W9pDCPb2' ) as cuic
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='R9Lw1uNtRuj' ) as firstname
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='TBt2a4Bq0Lx' ) as lastname
, finaltesttesultdata.value as finaltest
					
from programstageinstance psi
inner join organisationunit org on org.organisationunitid=psi.organisationunitid
inner join programinstance pi on pi.programinstanceid=psi.programinstanceid
inner join trackedentityinstance tei on tei.trackedentityinstanceid=pi.trackedentityinstanceid
inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=psi.attributeoptioncomboid
inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid
inner join programstage pgs on  pgs.programstageid=psi.programstageid

left outer join ( select couplecuicoption.value, couplecuicoption.programstageinstanceid 
		from trackedentitydatavalue as couplecuicoption
				inner join dataelement de on de.dataelementid=couplecuicoption.dataelementid
					and de.uid = 'csHM60DUGkG' ) as coupleoption
	on coupleoption.programstageinstanceid=psi.programstageinstanceid
	
	
left outer join ( select couplecuicoption.value, couplecuicoption.programstageinstanceid 
		from trackedentitydatavalue as couplecuicoption
				inner join dataelement de on de.dataelementid=couplecuicoption.dataelementid
					and de.uid = 'UYyCL2xz8Wz' ) as partner
	on partner.programstageinstanceid=psi.programstageinstanceid
		
left outer join ( select finaltestresult.value, finaltestresult.programstageinstanceid 
		from trackedentitydatavalue as finaltestresult
				inner join dataelement de on de.dataelementid=finaltestresult.dataelementid
					and de.uid = 'UuKat0HFjWS' ) as finaltesttesultdata
	on finaltesttesultdata.programstageinstanceid=psi.programstageinstanceid

where psi.uid = '${partnerEventId}'




--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_PositiveCases

select -- DISTINCT ON(psi.organisationunitid, psi.programstageid)
 tei.uid, psi.uid, psi.executiondate, finaltesttesultdata.value
, ( select value from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='rw3W9pDCPb2' ) as cuic

, ( select COUNT(_psi.programstageinstanceid) 
			from programstageinstance _psi
					inner join programinstance _pi on _pi.programinstanceid=_psi.programinstanceid
					inner join programstage _prgs on _prgs.programstageid=_psi.programstageid
			where _pi.programinstanceid=pi.programinstanceid
					and _prgs.uid='${stageId}' ) as noevent
, org.name

, ( select optval.name from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
				INNER JOIN trackedentityinstance _tei on _tei.trackedentityinstanceid=_teav.trackedentityinstanceid
				INNER JOIN optionset opts on opts.optionsetid=_tea.optionsetid
				INNER JOIN optionvalue optval on optval.optionsetid=opts.optionsetid
			where pi.trackedentityinstanceid=_tei.trackedentityinstanceid
					and _tea.uid='mYdfuRItatP' and _teav.value=optval.code ) as artstatus

, ( select DISTINCT on ( optval.name ) optval.name from trackedentitydatavalue _tedv 
				INNER JOIN dataelement _de on _de.dataelementid=_tedv.dataelementid
				inner join programstageinstance _psi on _tedv.programstageinstanceid=_psi.programstageinstanceid
				INNER JOIN optionset opts on opts.optionsetid=_de.optionsetid
				INNER JOIN optionvalue optval on optval.optionsetid=opts.optionsetid
		where _psi.programinstanceid=pi.programinstanceid
					and _de.uid='E1KAxdya3y5' and _tedv.value=optval.code ) as artopeningfacility



from programstageinstance psi
inner join organisationunit org on org.organisationunitid=psi.organisationunitid
inner join programinstance pi on pi.programinstanceid=psi.programinstanceid
inner join trackedentityinstance tei on tei.trackedentityinstanceid=pi.trackedentityinstanceid
inner join categoryoptioncombo catoptcom on catoptcom.categoryoptioncomboid=psi.attributeoptioncomboid
inner join categoryoptioncombos_categoryoptions catoptrls on catoptrls.categoryoptioncomboid=catoptcom.categoryoptioncomboid
inner join dataelementcategoryoption catOption on catOption.categoryoptionid=catoptrls.categoryoptionid


left outer join ( select finaltestresult.value, finaltestresult.programstageinstanceid 
		from trackedentitydatavalue as finaltestresult
				inner join dataelement de on de.dataelementid=finaltestresult.dataelementid
					and de.uid = 'UuKat0HFjWS' ) as finaltesttesultdata
	on finaltesttesultdata.programstageinstanceid=psi.programstageinstanceid



/* 
where psi.executiondate >= '2017-01-01' and psi.executiondate < '2017-07-01'
 	and psi.programstageid in ( select _ps.programstageid 
				from programstage _ps where _ps.uid = 'lVglvBnE3TY' )
	and catOption.code='TES001'
*/

 where psi.executiondate >= '${startDate}' and psi.executiondate < '${endDate}'
 	and psi.programstageid in ( select _ps.programstageid 
				from programstage _ps where _ps.uid = '${stageId}' )
	and catOption.code='${username}'



	and psi.programstageinstanceid in (
		select _tedv.programstageinstanceid from trackedentitydatavalue _tedv 
				INNER JOIN dataelement _de on _de.dataelementid=_tedv.dataelementid
					and _de.uid='UuKat0HFjWS' and _tedv.value='Positive'
	)

ORDER  BY psi.organisationunitid, psi.programstageid, psi.executiondate DESC





--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_searchClients


select tei_client.uid

, ( CASE WHEN ( "R9Lw1uNtRuj".value is null ) THEN ' ' ELSE ' ' || "R9Lw1uNtRuj".value END ) as firstname
, ( CASE WHEN ( "TBt2a4Bq0Lx".value is null ) THEN ' ' ELSE ' ' || "TBt2a4Bq0Lx".value END ) as lastname
, ( CASE WHEN ( "BvsJfkddTgZ".value is null ) THEN ' ' ELSE ' ' || "BvsJfkddTgZ".value END ) as birthdate
, ( CASE WHEN ( "u57uh7lHwF8".value is null ) THEN ' ' ELSE ' ' || "u57uh7lHwF8".value END ) as birthdistrict
, ( CASE WHEN ( "vTPYC9BXPNn".value is null ) THEN ' ' ELSE ' ' || "vTPYC9BXPNn".value END ) as birthorder
, pi_client.enrollmentdate
, max( latest_event.executiondate ) as latestevent

from trackedentityinstance as tei_client

inner join programinstance as pi_client
	on tei_client.trackedentityinstanceid = pi_client.trackedentityinstanceid

left outer join programstageinstance as latest_event
	on pi_client.programinstanceid = latest_event.programinstanceid

inner join program as prg 
	on prg.programid = pi_client.programid

-- firstname
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='R9Lw1uNtRuj' ) as "R9Lw1uNtRuj"
	on "R9Lw1uNtRuj".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- lastname
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='TBt2a4Bq0Lx' ) as "TBt2a4Bq0Lx" 
	on "TBt2a4Bq0Lx".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- birthdate
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='BvsJfkddTgZ' ) as "BvsJfkddTgZ" 
	on "BvsJfkddTgZ".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- district
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='u57uh7lHwF8' ) as "u57uh7lHwF8" 
	on "u57uh7lHwF8".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- birth order
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='vTPYC9BXPNn' ) as "vTPYC9BXPNn" -- district
	on "vTPYC9BXPNn".trackedentityinstanceid = tei_client.trackedentityinstanceid

where prg.uid='KDgzpKX3h2S' 

and  replace( ( CASE WHEN ( "R9Lw1uNtRuj".value is null ) THEN ' ' ELSE ' ' || "R9Lw1uNtRuj".value END )  , '''', '-')   
		ilike '%${R9Lw1uNtRuj}%'
and  replace( ( CASE WHEN ( "TBt2a4Bq0Lx".value is null ) THEN ' ' ELSE ' ' || "TBt2a4Bq0Lx".value END ) , '''', '-') 
		ilike '%${TBt2a4Bq0Lx}%'		
and  replace( ( CASE WHEN ( "BvsJfkddTgZ".value is null ) THEN ' ' ELSE ' ' || "BvsJfkddTgZ".value END ) , '''', '-') 
		ilike '%${BvsJfkddTgZ}%'
and  replace( ( CASE WHEN ( "u57uh7lHwF8".value is null ) THEN ' ' ELSE ' ' || "u57uh7lHwF8".value END ) , '''', '-') 
		ilike '%${u57uh7lHwF8}%'		
and  replace( ( CASE WHEN ( "vTPYC9BXPNn".value is null ) THEN ' ' ELSE ' ' || "vTPYC9BXPNn".value END ) , '''', '-') 
		ilike '%${vTPYC9BXPNn}%'		

group by tei_client.uid, "R9Lw1uNtRuj".value, "TBt2a4Bq0Lx".value
, "BvsJfkddTgZ".value, "u57uh7lHwF8".value
, "vTPYC9BXPNn".value, pi_client.enrollmentdate, tei_client.created

ORDER BY tei_client.created





--------------------------------------------------------------------------------
---- LSDescoveryAndDesign_SearchPositiveClient


select tei_client.uid

, ( CASE WHEN ( "R9Lw1uNtRuj".value is null ) THEN ' ' ELSE ' ' || "R9Lw1uNtRuj".value END ) as firstname
, ( CASE WHEN ( "TBt2a4Bq0Lx".value is null ) THEN ' ' ELSE ' ' || "TBt2a4Bq0Lx".value END ) as lastname
, ( CASE WHEN ( "BvsJfkddTgZ".value is null ) THEN ' ' ELSE ' ' || "BvsJfkddTgZ".value END ) as birthdate
, ( CASE WHEN ( "u57uh7lHwF8".value is null ) THEN ' ' ELSE ' ' || "u57uh7lHwF8".value END ) as birthdistrict
, ( CASE WHEN ( "vTPYC9BXPNn".value is null ) THEN ' ' ELSE ' ' || "vTPYC9BXPNn".value END ) as birthorder
, pi_client.enrollmentdate
, max( event.executiondate ) as event

from trackedentityinstance as tei_client

inner join programinstance as pi_client
	on tei_client.trackedentityinstanceid = pi_client.trackedentityinstanceid

left outer join programstageinstance as event
	on pi_client.programinstanceid = event.programinstanceid

inner join program as prg 
	on prg.programid = pi_client.programid

-- firstname
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='R9Lw1uNtRuj' ) as "R9Lw1uNtRuj"
	on "R9Lw1uNtRuj".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- lastname
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='TBt2a4Bq0Lx' ) as "TBt2a4Bq0Lx" 
	on "TBt2a4Bq0Lx".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- birthdate
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='BvsJfkddTgZ' ) as "BvsJfkddTgZ" 
	on "BvsJfkddTgZ".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- district
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='u57uh7lHwF8' ) as "u57uh7lHwF8" 
	on "u57uh7lHwF8".trackedentityinstanceid = tei_client.trackedentityinstanceid

-- birth order
left outer join ( select _teav.trackedentityinstanceid, _teav.value
		from psi_view_trackedentityattributevalue _teav
			inner join psi_view_trackedentityattribute _tea on _teav.trackedentityattributeid=_tea.trackedentityattributeid
		where _tea.uid='vTPYC9BXPNn' ) as "vTPYC9BXPNn" -- district
	on "vTPYC9BXPNn".trackedentityinstanceid = tei_client.trackedentityinstanceid


where prg.uid='KDgzpKX3h2S' 

and  replace( ( CASE WHEN ( "R9Lw1uNtRuj".value is null ) THEN ' ' ELSE ' ' || "R9Lw1uNtRuj".value END )  , '''', '-')   
		ilike '%${R9Lw1uNtRuj}%'
and  replace( ( CASE WHEN ( "TBt2a4Bq0Lx".value is null ) THEN ' ' ELSE ' ' || "TBt2a4Bq0Lx".value END ) , '''', '-') 
		ilike '%${TBt2a4Bq0Lx}%'		
and  replace( ( CASE WHEN ( "BvsJfkddTgZ".value is null ) THEN ' ' ELSE ' ' || "BvsJfkddTgZ".value END ) , '''', '-') 
		ilike '%${BvsJfkddTgZ}%'
and  replace( ( CASE WHEN ( "u57uh7lHwF8".value is null ) THEN ' ' ELSE ' ' || "u57uh7lHwF8".value END ) , '''', '-') 
		ilike '%${u57uh7lHwF8}%'		
and  replace( ( CASE WHEN ( "vTPYC9BXPNn".value is null ) THEN ' ' ELSE ' ' || "vTPYC9BXPNn".value END ) , '''', '-') 
		ilike '%${vTPYC9BXPNn}%'

and event.programstageinstanceid in (
		select _tedv.programstageinstanceid from trackedentitydatavalue _tedv 
				INNER JOIN dataelement _de on _de.dataelementid=_tedv.dataelementid
					and _de.uid='UuKat0HFjWS' and _tedv.value='Positive'
	)
	
group by tei_client.uid, "R9Lw1uNtRuj".value, "TBt2a4Bq0Lx".value
, "BvsJfkddTgZ".value, "u57uh7lHwF8".value
, "vTPYC9BXPNn".value, pi_client.enrollmentdate, tei_client.created

ORDER BY tei_client.created



/////////////////////////////////// All FollowUp Improve /////////////////////////////////////////

select tei.uid

, cuic.value

, counsil.value

, extract(day from (
    date 'now()' - openartevent.executiondate 
) ) as daySinceDiagnosis 

, _tedv_lastactionname.value
, contactevent.executiondate as lasteventdate
, _tedv_nextactionname.value
, _tedv_nextactionduedate.value

from trackedentityinstance tei
inner join programinstance pi 
			on pi.trackedentityinstanceid=tei.trackedentityinstanceid
inner join programstageinstance openartevent
			on openartevent.programinstanceid=pi.programinstanceid
inner join programstage stage 
			on stage.programid=pi.programid

left outer join ( select _teav.value, _teav.trackedentityinstanceid  from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where _tea.uid='zRA08XEYiSF' ) as cuic on tei.trackedentityinstanceid=cuic.trackedentityinstanceid 

left outer join ( select _teav.value, _teav.trackedentityinstanceid  from psi_view_trackedentityattributevalue _teav
				INNER JOIN psi_view_trackedentityattribute _tea on _tea.trackedentityattributeid=_teav.trackedentityattributeid
			where _tea.uid='NLNTtpbT3c5' ) as counsil on tei.trackedentityinstanceid=counsil.trackedentityinstanceid 

-----------------------

left outer join ( select contactlogevent.executiondate, contactlogevent.programinstanceid ,  contactlogevent.programstageinstanceid
    from programstageinstance contactlogevent 
		inner join programstage _stage 
			on _stage.programstageid = contactlogevent.programstageid and _stage.uid='gmBozy0KAMC' order by contactlogevent.executiondate desc limit 1 ) as contactevent 
	on pi.programinstanceid = contactevent.programinstanceid 


left outer join trackedentitydatavalue _tedv_lastactionname
  on _tedv_lastactionname.dataelementid = 942514 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_lastactionname.programstageinstanceid 


left outer join trackedentitydatavalue _tedv_nextactionname
  on _tedv_nextactionname.dataelementid = 942516 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_nextactionname.programstageinstanceid 

left outer join trackedentitydatavalue _tedv_nextactionduedate
  on _tedv_nextactionduedate.dataelementid = 967606 -- IDs are different beteen servers
		and contactevent.programstageinstanceid = _tedv_nextactionduedate.programstageinstanceid 


/*

left outer join ( select _tedv.value, lastactionname.programstageinstanceid 
	from trackedentitydatavalue _tedv 
	where _tedv.dataelementid = 942514 ) as lastactionname on contactevent.programstageinstanceid = lastactionname.programstageinstanceid 

*/
-----------------------

where stage.uid='OSpZnLBMVhr'

group by tei.uid, tei.trackedentityinstanceid, openartevent.executiondate, cuic.value, counsil.value
,contactevent.executiondate, _tedv_lastactionname.value, _tedv_nextactionname.value, _tedv_nextactionduedate.value




